# yaml-language-server: $schema=https://json.schemastore.org/github-workflow
name: Multi-platform Packages

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

env:
  LINUX_CMAKE_ARGS: >-
    -DQT6=ON
    -DQML=ON
    -DBULK=ON
    -DFFMPEG=ON
    -DLOCALECOMPARE=ON
    -DMAD=ON
    -DMODPLUG=ON
    -DWAVPACK=ON
    -DINSTALL_USER_UDEV_RULES=OFF

jobs:
  core-builds:
    name: Build core targets (DEB/Windows/APK)
    uses: ./.github/workflows/build.yml
    with:
      publish: false
      branch: ${{ github.ref_name }}
      ref: ${{ github.ref }}

  linux-packages:
    name: Linux packages (RPM + AppImage)
    runs-on: ubuntu-24.04
    env:
      BUILDENV_BASEPATH: /home/runner/buildenv
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Ensure that all tags are fetched
        run: git fetch origin --force --tags

      - name: Set up build environment
        run: tools/debian_buildenv.sh setup
        env:
          BUILDENV_BASEPATH: ${{ env.BUILDENV_BASEPATH }}

      - name: Install packaging tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm libfuse2 patchelf desktop-file-utils zsync
          wget -q https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          sudo mv appimagetool /usr/local/bin/
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage -O linuxdeploy
          chmod +x linuxdeploy
          sudo mv linuxdeploy /usr/local/bin/
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage -O linuxdeploy-plugin-qt
          chmod +x linuxdeploy-plugin-qt
          sudo mv linuxdeploy-plugin-qt /usr/local/bin/

      - name: Configure
        run: |
          mkdir -p build
          cmake ${{ env.LINUX_CMAKE_ARGS }} \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DWARNINGS_FATAL=ON \
            -DDEBUG_ASSERTIONS_FATAL=OFF \
            -DBATTERY=ON \
            -DBROADCAST=ON \
            -DDOWNLOAD_MANUAL=ON \
            -DHID=ON \
            -DKEYFINDER=ON \
            -DLILV=ON \
            -DOPUS=ON \
            -DQTKEYCHAIN=ON \
            -DVINYLCONTROL=ON \
            -DCMAKE_VERBOSE_MAKEFILE=OFF \
            -L \
            ..
        working-directory: build

      - name: Build
        run: cmake --build . --config RelWithDebInfo
        working-directory: build

      - name: Package
        run: |
          cd build
          cpack -G RPM -V
          export APPIMAGE_EXTRACT_AND_RUN=1
          cpack -G AppImage -V

      - name: Upload RPM packages
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages
          path: build/*.rpm
          if-no-files-found: error

      - name: Upload AppImage packages
        uses: actions/upload-artifact@v4
        with:
          name: appimage-packages
          path: build/*.AppImage
          if-no-files-found: error
